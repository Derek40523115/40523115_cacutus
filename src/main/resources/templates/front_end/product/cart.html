<div th:replace="~{/front_end/product/include_top}"></div>
  <body>
  
  <div th:replace="~{/front_end/product/include_body}"></div>
  
    <div class="page-holder">
      <!-- navbar-->
<!--       <header class="header bg-white"> -->
<!--         <div class="container px-lg-3"> -->
<!--           <nav class="navbar navbar-expand-lg navbar-light py-3 px-lg-0"><a class="navbar-brand" href="index.html"><span class="fw-bold text-uppercase text-dark">Boutique</span></a> -->
<!--             <button class="navbar-toggler navbar-toggler-end" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button> -->
<!--             <div class="collapse navbar-collapse" id="navbarSupportedContent"> -->
<!--               <ul class="navbar-nav me-auto"> -->
<!--                 <li class="nav-item"> -->
<!--                   Link<a class="nav-link" href="index.html">Home</a> -->
<!--                 </li> -->
<!--                 <li class="nav-item"> -->
<!--                   Link<a class="nav-link" href="shop.html">Shop</a> -->
<!--                 </li> -->
<!--                 <li class="nav-item"> -->
<!--                   Link<a class="nav-link" href="detail.html">Product detail</a> -->
<!--                 </li> -->
<!--                 <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" id="pagesDropdown" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a> -->
<!--                   <div class="dropdown-menu mt-3 shadow-sm" aria-labelledby="pagesDropdown"><a class="dropdown-item border-0 transition-link" href="index.html">Homepage</a><a class="dropdown-item border-0 transition-link" href="shop.html">Category</a><a class="dropdown-item border-0 transition-link" href="detail.html">Product detail</a><a class="dropdown-item border-0 transition-link" href="cart.html">Shopping cart</a><a class="dropdown-item border-0 transition-link" href="checkout.html">Checkout</a></div> -->
<!--                 </li> -->
<!--               </ul> -->
<!--               <ul class="navbar-nav ms-auto">                -->
<!--                 <li class="nav-item"><a class="nav-link" href="cart.html"> <i class="fas fa-dolly-flatbed me-1 text-gray"></i>Cart<small class="text-gray fw-normal">(2)</small></a></li> -->
<!--                 <li class="nav-item"><a class="nav-link" href="#!"> <i class="far fa-heart me-1"></i><small class="text-gray fw-normal"> (0)</small></a></li> -->
<!--                 <li class="nav-item"><a class="nav-link" href="#!"> <i class="fas fa-user me-1 text-gray fw-normal"></i>Login</a></li> -->
<!--               </ul> -->
<!--             </div> -->
<!--           </nav> -->
<!--         </div> -->
<!--       </header> -->
      <!--  Modal -->
      <div class="modal fade" id="productView" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content overflow-hidden border-0">
            <button class="btn-close p-4 position-absolute top-0 end-0 z-index-20 shadow-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body p-0">
              <div class="row align-items-stretch">
                <div class="col-lg-6 p-lg-0"><a class="glightbox product-view d-block h-100 bg-cover bg-center" style="background: url(img/product-5.jpg)" href="img/product-5.jpg" data-gallery="gallery1" data-glightbox="Red digital smartwatch"></a><a class="glightbox d-none" href="img/product-5-alt-1.jpg" data-gallery="gallery1" data-glightbox="Red digital smartwatch"></a><a class="glightbox d-none" href="img/product-5-alt-2.jpg" data-gallery="gallery1" data-glightbox="Red digital smartwatch"></a></div>
                <div class="col-lg-6">
                  <div class="p-4 my-md-4">
                    <ul class="list-inline mb-2">
                      <li class="list-inline-item m-0"><i class="fas fa-star small text-warning"></i></li>
                      <li class="list-inline-item m-0 1"><i class="fas fa-star small text-warning"></i></li>
                      <li class="list-inline-item m-0 2"><i class="fas fa-star small text-warning"></i></li>
                      <li class="list-inline-item m-0 3"><i class="fas fa-star small text-warning"></i></li>
                      <li class="list-inline-item m-0 4"><i class="fas fa-star small text-warning"></i></li>
                    </ul>
                    <h2 class="h4">Red digital smartwatch</h2>
                    <p class="text-muted">$250</p>
                    <p class="text-sm mb-4">Lorem ipsum dolor sit amet, consectetur adipiscing elit. In ut ullamcorper leo, eget euismod orci. Cum sociis natoque penatibus et magnis dis parturient montes nascetur ridiculus mus. Vestibulum ultricies aliquam convallis.</p>
                    <div class="row align-items-stretch mb-4 gx-0">
                      <div class="col-sm-7">
                        <div class="border d-flex align-items-center justify-content-between py-1 px-3"><span class="small text-uppercase text-gray mr-4 no-select">Quantity</span>
                          <div class="quantity">
                            <button class="dec-btn p-0"><i class="fas fa-caret-left"></i></button>
                            <input class="form-control border-0 shadow-0 p-0" type="text" value="1">
                            <button class="inc-btn p-0"><i class="fas fa-caret-right"></i></button>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-5"><a class="btn btn-dark btn-sm w-100 h-100 d-flex align-items-center justify-content-center px-0" href="cart.html">Add to cart</a></div>
                    </div><a class="btn btn-link text-dark text-decoration-none p-0" href="#!"><i class="far fa-heart me-2"></i>Add to wish list</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container">
      <form action="/shopCart/CartToCheckout2" method="post">
        <!-- HERO SECTION-->
        <section class="py-5 bg-light">
          <div class="container">
            <div class="row px-4 px-lg-5 py-lg-4 align-items-center">
              <div class="col-lg-6">
                <h1 class="h2 text-uppercase mb-0">Cart</h1>
              </div>
              <div class="col-lg-6 text-lg-end">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb justify-content-lg-end mb-0 px-0 bg-light">
                    <li class="breadcrumb-item"><a class="text-dark" href="index.html">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Cart</li>
                  </ol>
                </nav>
              </div>
            </div>
          </div>
        </section>
        <section class="py-5">
          <h2 class="h5 text-uppercase mb-4">Shopping cart</h2>
          <div class="row">
            <div class="col-lg-8 mb-4 mb-lg-0">
              <!-- CART TABLE-->
              <div class="table-responsive mb-4">
                <table class="table text-nowrap">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Product</strong></th>
                      <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Price</strong></th>
                      <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Quantity</strong></th>
                      <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase">Total</strong></th>
                      <th class="border-0 p-3" scope="col"> <strong class="text-sm text-uppercase"></strong></th>
                    </tr>
                  </thead>
                  <tbody class="border-0">
                  <th:block th:if="${cartVO != null}" th:each="cartVO : ${cartVO}">
                    <tr>
                    <input class="productId"  type="hidden" th:value="${cartVO.productId}">
                      <th class="ps-0 py-3 border-light" scope="row">
                        <div class="d-flex align-items-center">
                        <a class="reset-anchor d-block animsition-link" href="detail.html"><img th:src="@{/product/ShowProductPic} + '?productId=' + ${cartVO.productId} + '&productPhotoId=' + ${productFirstPhotoId[cartVO.productId]}" alt="..." width="70"/></a>
                          <div class="ms-3"><strong class="h6"><a class="reset-anchor animsition-link" name="productName" href="detail.html" th:text="${cartVO.productName}">Red digital smartwatch</a></strong></div>
                          <input type="hidden" name="productName" th:value="${cartVO.productName}">
                        </div>
                      </th>
                      <td class="p-3 align-middle border-light">
                        <p class="mb-0 small" th:text="'$'+${cartVO.price}">$250</p>
                      </td>
                      <td class="p-3 align-middle border-light">
                        <div class="border d-flex align-items-center justify-content-between px-3"><span class="small text-uppercase text-gray headings-font-family">Quantity</span>
                          <div class="quantity">
                            <button type="button" class="dec-btn p-0"><i class="fas fa-caret-left"></i></button>
                            <input class="form-control form-control-sm border-0 shadow-0 p-0 quantityInput" type="text" th:value="${cartVO.quantity}"/>
                            <button type="button" class="inc-btn p-0"><i class="fas fa-caret-right"></i></button>
                          </div>
                        </div>
                      </td>
                      <td class="p-3 align-middle border-light">
                        <p class="mb-0 small" name="productTotalPrice" th:text="'$'+${cartVO.quantity * cartVO.price}">$250</p>
                        <input type="hidden" name="productTotalValue" th:value="${cartVO.quantity * cartVO.price}">
                      </td>
                      <td class="p-3 align-middle border-light"><a class="reset-anchor remove-button" name="remove-button" href="#!"><i class="fas fa-trash-alt small text-muted" th:attr="data-product-id=${cartVO.productId}"></i></a></td>
                    </tr>
                    </th:block>
                  </tbody>
                </table>
              </div>
              <!-- CART NAV-->
              <div class="bg-light px-4 py-3">
                <div class="row align-items-center text-center">
                  <div class="col-md-6 mb-3 mb-md-0 text-md-start"><a class="btn btn-link p-0 text-dark btn-sm" href="shop.html"><i class="fas fa-long-arrow-alt-left me-2"> </i>Continue shopping</a></div>
                  <div class="col-md-6 text-md-end"><button type="submit" class="btn btn-outline-dark btn-sm">Procceed to checkout<i class="fas fa-long-arrow-alt-right ms-2"></i></button></div>
                </div>
              </div>
            </div>
            <!-- ORDER TOTAL-->
            <div class="col-lg-4">
              <div class="card border-0 rounded-0 p-lg-4 bg-light">
                <div class="card-body">
                  <h5 class="text-uppercase mb-4">Cart total</h5>
                  <ul class="list-unstyled mb-0">
                    <li class="d-flex align-items-center justify-content-between"><strong class="text-uppercase small font-weight-bold">Discount</strong><span class="text-muted small" id="discount-amount">$250</span><input type="hidden"  name="discount-amount"></li>
                    <li class="border-bottom my-2"></li>
                    <li class="d-flex align-items-center justify-content-between mb-4"><strong class="text-uppercase small font-weight-bold">Total</strong><span id="totalCount">$250</span><input type="hidden" name="totalCount" value="250"></li>
                    <li>
                      <form action="#">
                        <div class="input-group mb-0">
<!--                           <input class="form-control" type="text" placeholder="Enter your coupon"> -->
<!--                           <button class="btn btn-dark btn-sm w-100" type="submit"> <i class="fas fa-gift me-2"></i>Apply coupon</button> -->
                        <select class="form-control" name="productPromotion" id="productPromotion">
							<option value="0">請選擇活動優惠</option>
							<option th:each="item : ${shopProductDiscount}" th:value="${item.promotionCoupon}" th:text="${item.promotionTitle}"/>
						</select>
                        </div>
                      </form>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
      </form>
      <footer class="bg-dark text-white">
        <div class="container py-4">
          <div class="row py-5">
            <div class="col-md-4 mb-3 mb-md-0">
              <h6 class="text-uppercase mb-3">Customer services</h6>
              <ul class="list-unstyled mb-0">
                <li><a class="footer-link" href="#!">Help &amp; Contact Us</a></li>
                <li><a class="footer-link" href="#!">Returns &amp; Refunds</a></li>
                <li><a class="footer-link" href="#!">Online Stores</a></li>
                <li><a class="footer-link" href="#!">Terms &amp; Conditions</a></li>
              </ul>
            </div>
            <div class="col-md-4 mb-3 mb-md-0">
              <h6 class="text-uppercase mb-3">Company</h6>
              <ul class="list-unstyled mb-0">
                <li><a class="footer-link" href="#!">What We Do</a></li>
                <li><a class="footer-link" href="#!">Available Services</a></li>
                <li><a class="footer-link" href="#!">Latest Posts</a></li>
                <li><a class="footer-link" href="#!">FAQs</a></li>
              </ul>
            </div>
            <div class="col-md-4">
              <h6 class="text-uppercase mb-3">Social media</h6>
              <ul class="list-unstyled mb-0">
                <li><a class="footer-link" href="#!">Twitter</a></li>
                <li><a class="footer-link" href="#!">Instagram</a></li>
                <li><a class="footer-link" href="#!">Tumblr</a></li>
                <li><a class="footer-link" href="#!">Pinterest</a></li>
              </ul>
            </div>
          </div>
          <div class="border-top pt-4" style="border-color: #1d1d1d !important">
            <div class="row">
              <div class="col-md-6 text-center text-md-start">
                <p class="small text-muted mb-0">&copy; All rights reserved.</p>
              </div>
              <div class="col-md-6 text-center text-md-end">
                <p class="small text-muted mb-0"><a target="_blank" href="http://www.mobanwang.com/" title="网页模板" class="text-white reset-anchor">网页模板</a></p>
              </div>
            </div>
          </div>
        </div>
      </footer>
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script> 
        
        <script>
//=============================購物車總價===============================
	$(document).ready(function(){
		
		
		
// 		const productTotalPrice = $("[name='productTotalPrice']");//每個商品的總價
// // 		console.log(productTotalPrice);
// 		let cartTotal = 0;
// 		$.each(productTotalPrice, function(index, item){
// 			let priceWithoutDollar = $(item).text().replace("$","");
// 			cartTotal += parseFloat(priceWithoutDollar);
// 		})
// // 		console.log(cartTotal);
// 		$("#totalCount").text("$"+cartTotal);
		
//================================選折價更改價格=================================
		

// 		console.log($("#totalCount"));
		const discountAmount = $("#discount-amount");//商品折數
		
		var promotion = "0";//套用到切換商品數量折扣判斷
		
		$("#productPromotion").on("change", function(){
			promotion = parseFloat(this.value || "0");
			// 如果活動折扣是 0，直接顯示總金額；否則，應用折扣
	        if (promotion === 0) {
	        	$("#totalCount").text('$' + cartTotal);
	        	$("[name='totalCount']").val(cartTotal);//給input放入總價，給後端做數據傳輸使用
	            discountAmount.html("");
	        } else {
	        	$("#totalCount").text('$' + Math.round(cartTotal * promotion));
	        	$("[name='totalCount']").val(Math.round(cartTotal * promotion));//給input放入總價，給後端做數據傳輸使用
	        }
	        
	        if(promotion *10 % 1 == 0 && promotion!=0){
	        	discountAmount.html(promotion*10 + "折");
	        	$("input[name='discount-amount']").val(promotion*10 + "折");
	        }
	        else{
	        	discountAmount.html(Math.round(promotion*100) + "折");
	        	$("input[name='discount-amount']").val(Math.round(promotion*100) + "折");
	        }
	        	 
	        	
// 	         console.log(productPromotion.value*100);
		})

//===========================切換數量更改價格====================================
// 		function quantityFunction(e){
// 			console.log(e.target.value);
// 			alert(e.target.value);
// 		}
		
		 
		// 當點擊增加按鈕
	    $(".inc-btn").click(function(e){
	    	let quantityInput = $(this).siblings("input");  // 找到相鄰的 input 框
	        let currentValue = parseInt(quantityInput.val()) || 1;  // 確保值為數字，默認為1
// 	        quantityInput.val(currentValue + 1);  // 增加1
	    	const itemRow =$(this).closest("tr");
	    	updateItemTotal(itemRow);  // 更新價格
	    	updateCartTotal();
	    	
	    	//Redis變更
	    	const productId = itemRow.find('.productId').val();
// 	    	console.log(productId);
            const quantity = parseInt(quantityInput.val());
// 	    	console.log(quantity);
            updateRedisCart(productId, quantity);
	    });

	    // 當點擊減少按鈕
	    $(".dec-btn").click(function(){
	    	const itemRow =$(this).closest("tr");
	    	
	        let quantityInput = $(this).siblings("input");  // 找到相鄰的 input 框
	        let currentValue = parseInt(quantityInput.val()) || 1;  // 確保值為數字，默認為1
// 	        if (currentValue > 1) {  // 防止數量小於1
// 	            quantityInput.val(currentValue - 1);  // 減少1
	            updateItemTotal(itemRow);  // 更新價格
	    		updateCartTotal();
	            
	    		//Redis變更
		    	const productId = itemRow.find('.productId').val();//找ID
// 		    	console.log(productId);
	            const quantity = parseInt(quantityInput.val());//找輸入內容
// 		    	console.log(quantity);
	            updateRedisCart(productId, quantity);  
// 	        }
	    });

	    // 當直接更改輸入框中的數量
	    $(".quantityInput").on("input", function() {
	        let currentValue = parseInt($(this).val()) || 1;  // 確保值為數字，默認為1
	        $(this).val(currentValue);  // 確保不輸入非法字符
	        const itemRow =$(this).closest("tr");
	        updateItemTotal(itemRow);  // 更新價格
	        updateCartTotal();
	        
	      //Redis變更
	    	const productId = itemRow.find('.productId').val();//找ID
// 		    	console.log(productId);
            const quantity = parseInt(currentValue);//找輸入內容
// 		    	console.log(quantity);
            updateRedisCart(productId, quantity);  
	    });

	    // 更新單項商品總價
	    function updateItemTotal(itemRow) {
	    	const quantityInput = itemRow.find('input[type="text"]'); // 使用 jQuery 的 find 方法
	        const itemTotalElement = itemRow.find('p[name="productTotalPrice"]');
	        const itemPriceElement = itemRow.find('.mb-0.small').first();
	        const quantity = parseInt(quantityInput.val()); // 使用 jQuery 的 val 方法獲取值
// 	         console.log(quantity);
	        const itemPrice = parseInt(itemPriceElement.text().replace("$",""));
// 	         console.log(itemPrice);
	        const itemTotal = quantity * itemPrice;
// 	        console.log(itemTotal);
	        itemTotalElement.text('$' + itemTotal);
	    }
	    
	    let cartTotal = 0;//折扣要用的
	    
	    updateCartTotal();//剛進來要執行一次抓購物車總價

	    // 更新整個購物車的總價格
	    function updateCartTotal() {
	    	cartTotal = 0;
	        $('p[name="productTotalPrice"]').each(function() {
	            let price = parseFloat($(this).text().replace("$", "")) || 0;
	            console.log(price);
	            cartTotal += price;
	        });
// 	        $("#totalCount").text("$" + Math.round(cartTotal));  // 更新總金額顯示
	        
	        if (promotion == 0) {
	        	$("#totalCount").text('$' + cartTotal);
	        	$("[name='totalCount']").val(cartTotal);//給input放入總價，給後端做數據傳輸使用
// 	        	console.log(cartTotal);
// 	        	alert($("[name='totalCount']").val())
	            discountAmount.html("");
	        } else {
	        	$("#totalCount").text('$' + Math.round(cartTotal * promotion));
	        	$(".totalCount").val(Math.round(cartTotal * promotion));
	        	$("[name='totalCount']").val(Math.round(cartTotal * promotion));
// 	        	console.log(cartTotal);
// 	        	alert($("[name='totalCount']").val());
	        }
	        console.log(cartTotal);
	        
	    }
//===============Redis更新購物車資料=============================
	    function updateRedisCart(productId, quantity) {
	        const cartItem = {
	            productId: productId,
	            quantity: quantity,
	        };

	        $.ajax({
	            url: '/shopCart/upDateCart',
	            type: 'POST',
	            contentType: "application/json",
	            data: JSON.stringify(cartItem),
	            success: function (response) {
//	                 console.log(response);
	            },
	            error: function (xhr, status, error) {
	                console.error(error);
	            }
	        });
	    }
//==========================刪除商品============================
	
	
	// 移除商品
    function removeItem(event) {
    	
    	swal({
  		  text:"確定移除商品嗎?",
  		  icon: "warning",
  		  buttons: {
			      cancel: {
			        text: "取消",
			        visible: true
			      },
			      confirm: {
			        text: "確認",
			        visible: true
			      }
			    }
  		}).then(function(confirm){
  			if(confirm){
  				const currentItem = event.target.closest('tr');
//              console.log(event.target.attributes[1].value)
             currentItem.remove();
//              console.log("remove")
             updateCartTotal();
//              console.log("update total price")
             const productId = Number(event.target.getAttribute("data-product-id"));
//              console.log(event.target.getAttribute("data-product-id"));
//              console.log("productID="+productId);
             removeRedisCart(productId);
  			}else{
  				console.log("NO");
  			}
  		})
    	
    }
//     console.log($(".remove-button"));
    
    $(".remove-button").on("click", function(event) {
        removeItem(event);
    });
    
    
    
    function removeRedisCart(productId) {
//      console.log("call ajax");
     $.ajax({
         url: '/shopCart/removeOneCartItem',
         type: 'POST',
         contentType: "application/json",
         data: JSON.stringify({productId: productId}),
         success: function (response) {
//              console.log(response);
			//=============================================================//
 	        	//抓購物車裡的數量
 	        	$.ajax({
 	                url: '/shopCart/cartTotalNumber', 
 	                type: 'GET',
 	                success: function(response) {   
//  	                    console.log("shopNumber"+response);
 	                    $("span.cartnumber").text(response);
 	                    if(response == "0"){
 	                    	$("span.cartnumber").addClass("-cartnone")
 	                    }else{
 	                    	$("span.cartnumber").removeClass("-cartnone")
 	                    }
 	                },
 	                error: function(xhr, status, error) {
 	                    console.error("Error:", error);
 	                }
 	            });
 	    //=============================================================//
         },
         error: function (xhr, status, error) {
             console.error(error);
         }
     });
 }
    
	
		
	})
	
	
	

	

		

        </script>
       <div th:replace="~{/front_end/product/include_bottom}"></div>