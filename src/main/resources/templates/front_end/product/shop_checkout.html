<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<html>

<head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>通通給我健起來Give Me Gym Center</title>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
</head>

<body>

                <ul class="navbar-nav ml-auto">
                   
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/shopCart/shopCart}" id="toShopCart">
                        	<label>購物車在這:</label>
                            <span class="lnr lnr-cart"></span>
                        </a>
                    </li>
                </ul>
           




<div class="cart-container">
    <h2>結帳頁面</h2>
    <table>
        <thead>
        <tr>
            <th>商品編號</th>
            <th>商品名稱</th>
            <th>數量</th>
            <th>價格</th>
            <th>總價</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        <!-- 從AJAX動態新增 -->

        </tbody>
    </table>
    <div class="total-price">
        <p>訂單總價: <span id="cart-total"></span></p>
    </div>
</div>
<div class="checkout-form">
    <div class="payInfo">
        <h3 class="payInfo-title" style="text-align: left">使用者資訊</h3>
        <div class="payInfo-inputs">
            <label for="name">收件人姓名:</label>
            <input type="text" id="name" name="name" placeholder="請輸入收件人姓名" required>
            <label for="phone">聯絡電話:</label>
            <input type="tel" id="phone" placeholder="請輸入聯絡電話" required>
            <label for="address">收貨地址:</label>
            <input type="text" id="address" name="address" placeholder="請輸入地址" required>
        </div>
    </div>

    <button class="submit_order">確認下單</button>
</div>




<script>



const cartTotalElement = document.getElementById('cart-total');
function getShopCart() {
    $.ajax({
        url: '/shopCart/shopCartByMember',
        type: 'GET',
        success: function (response) {
            // 在此從後端取得處理成功回應的購物車資料  List<DetailDTO> list
            console.log(response);
            if (response != null) {
                // 迭代取出物件  變成
                const tableBody = document.getElementById("tableBody");
                let html = "";

                response.forEach(item => {
                    html += `<tr>
                                    <td>${item.productId}</td>
                                    <td>${item.productName}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price}</td>
                                    <td class="item-total">$${item.quantity * item.price}</td>
                                  </tr>`;
                });

                tableBody.innerHTML = html;

                updateCartTotal();
            } else {
                alert("尚未登入會員，請登入");
                window.location.href = '/front_end/member/memberLogin';
            }
        }
        ,
        error: function (xhr, status, error) {
            // 在此處理錯誤
            console.error(error);
        }
    });
}

getShopCart();



$('.submit_order').on('click', function() {
    if(confirm("確認下單?")){

        const cartTotalElement = document.getElementById('cart-total');
        var totalPrice = parseInt(cartTotalElement.textContent.replace('$', ''), 10);
        var name = $('#name').val();
        var phone = $('#phone').val();
        var address = $('#address').val();
    // 獲取要發送的數據
    var data = {
        totalPrice:totalPrice,
        name:name,
        phone:phone,
        address:address,
    };


    console.log(data);
    // 發送AJAX請求
    $.ajax({
        url: '/shopCart/checkoutOrder',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(response) {
            // 請求成功，可以在這裡處理後續操作或顯示成功訊息
            console.log(response);
            window.location.href = '/product/shopAllProduct';
        },
        error: function(xhr, status, error) {
            // 請求失敗，可以在這裡處理錯誤或顯示錯誤訊息
            console.error('請求失敗。狀態碼：' + xhr.status);
        }
    });
    }
});

function updateCartTotal() {
    const itemTotalElements = document.querySelectorAll('.item-total');
    let cartTotal = 0;
    itemTotalElements.forEach((itemTotalElement) => {
        const itemTotal = parseFloat(itemTotalElement.textContent.replace('$', ''));
        cartTotal += itemTotal;
        console.log(itemTotal);
        console.log(cartTotal);
    });
    cartTotalElement.textContent = '$' + cartTotal;
}


</script>


</body>

</html>